<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Tetris — мобильная версия, тач‑кнопки, звук и рекорды</title>
  <style>
    :root {
      --bg: #0b1020; --panel: #0f1530; --text: #e7ecff; --muted: #9aa4c7; --grid: #1a2144;
      --accent: #5dd6ff; --ok: #38ef7d; --warn: #ffd166; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Inter,Arial,"Noto Sans","Helvetica Neue",system-ui,sans-serif;color:var(--text);background:radial-gradient(1200px 600px at 20% -20%, #1a2360 0%, rgba(26,35,96,0) 60%), var(--bg);display:grid;place-items:center;touch-action:none}
    .wrap{display:grid;grid-template-columns:1fr auto;gap:16px;padding:16px;width:min(100vw,1040px);align-items:start}
    .board-card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;box-shadow:var(--shadow);position:relative}
    canvas#board{display:block;background:linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,.02)),repeating-linear-gradient(0deg,var(--grid) 0,var(--grid) 1px,transparent 1px,transparent 32px),repeating-linear-gradient(90deg,var(--grid) 0,var(--grid) 1px,transparent 1px,transparent 32px);border-radius:8px;image-rendering:pixelated;image-rendering:crisp-edges;max-width:100%;height:auto}
    .side{display:grid;gap:12px;min-width:300px}
    .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
    .panel h2{margin:0 0 8px;font-size:18px;font-weight:800;letter-spacing:.2px}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:baseline}
    .kv b{font-size:22px}
    .muted{color:var(--muted);font-size:13px}
    .next-hold{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mini{background:#0a0f24;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px;display:grid;place-items:center;height:120px}
    canvas.mini{image-rendering:pixelated;image-rendering:crisp-edges}
    .keys{font-size:13px;line-height:1.6;color:var(--muted)}
    .keys kbd{background:#0d132a;border:1px solid rgba(255,255,255,.12);border-bottom-color:rgba(255,255,255,.2);padding:2px 6px;border-radius:6px;color:var(--text);font-weight:600;font-size:12px;box-shadow:inset 0 -1px 0 rgba(255,255,255,.12)}
    .btnrow{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    button{background:#15204f;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:700;transition:transform .05s ease, filter .2s ease}
    button:active{transform:translateY(1px)}
    .footer{text-align:center;color:var(--muted);font-size:12px;margin-top:4px}
    .touchpad{display:grid;gap:8px}
    .touch-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .touch-wide{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tbtn{font-size:14px;padding:12px 10px}
    .tbtn.big{padding:16px 10px;font-size:16px}
    .row{display:flex;gap:8px}
    .grow{flex:1}

    .overlay{position:absolute;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;border-radius:12px}
    .overlay.show{display:flex}
    .overlay-card{background:#0f1530;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:16px;min-width:280px;max-width:360px;box-shadow:var(--shadow)}
    .overlay h3{margin:0 0 10px}
    .overlay .field{display:grid;gap:6px;margin:8px 0}
    .overlay input{background:#0a0f24;border:1px solid rgba(255,255,255,.12);border-radius:8px;color:var(--text);padding:10px;font-weight:700}
    .overlay .actions{display:flex;gap:8px;margin-top:12px}

    .scores{display:grid;gap:6px}
    .scores ol{margin:0;padding-left:20px}
    .scores li{margin:2px 0}

    .dedication{font-size:16px;font-weight:800;color:#ffd166;text-align:center;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.4)}

    /* Мобильные улучшения */
    @media (max-width: 900px){.wrap{grid-template-columns:1fr}.side{grid-template-columns:1fr}}
    @media (max-width: 520px){
      .panel h2{font-size:16px}
      .kv b{font-size:18px}
      .mini{height:100px}
      .tbtn{padding:10px 8px}
      .tbtn.big{padding:12px 8px}
      .side{min-width:unset}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="board-card">
      <canvas id="board" width="320" height="640"></canvas>
      <div id="overlay" class="overlay">
        <div class="overlay-card">
          <h3>Игра окончена</h3>
          <div class="muted">Счёт: <b id="ov-score">0</b> · Линии: <b id="ov-lines">0</b> · Уровень: <b id="ov-level">1</b></div>
          <div class="field">
            <label for="playerName" class="muted">Ваше имя для таблицы рекордов</label>
            <input id="playerName" type="text" maxlength="24" value="Игрок"/>
          </div>
          <div class="actions">
            <button id="btn-save" class="grow">Сохранить рекорд</button>
            <button id="btn-restart2">Рестарт</button>
          </div>
        </div>
      </div>
    </div>
    <div class="side">
      <div class="panel dedication">Сашульке — красотульке aka самой сладкой Булочке</div>
      <div class="panel">
        <h2>Статус</h2>
        <div class="kv"><span class="muted">Счёт</span> <b id="score">0</b></div>
        <div class="kv"><span class="muted">Линии</span> <b id="lines">0</b></div>
        <div class="kv"><span class="muted">Уровень</span> <b id="level">1</b></div>
        <div class="btnrow">
          <button id="btn-pause" title="P">Пауза</button>
          <button id="btn-restart" title="R">Рестарт</button>
        </div>
        <div class="btnrow" style="margin-top:8px">
          <button id="btn-sound" class="grow" title="M">Звук: выкл</button>
          <button id="btn-clear-scores" title="Очистить рекорды">Очистить рекорды</button>
        </div>
      </div>
      <div class="panel next-hold">
        <div>
          <h2>Далее</h2>
          <canvas id="next" class="mini" width="120" height="120"></canvas>
        </div>
        <div>
          <h2>Удержание</h2>
          <canvas id="hold" class="mini" width="120" height="120"></canvas>
        </div>
      </div>
      <div class="panel keys">
        <h2>Управление</h2>
        <div><kbd>←</kbd>/<kbd>→</kbd> — сдвиг, <kbd>↓</kbd> — мягкое падение</div>
        <div><kbd>↑</kbd>/<kbd>X</kbd> — вращение по часовой, <kbd>Z</kbd> — против</div>
        <div><kbd>Space</kbd> — жёсткий дроп, <kbd>C</kbd> — удержать, <kbd>P</kbd> — пауза, <kbd>R</kbd> — рестарт</div>
      </div>
      <div class="panel touchpad">
        <h2>Тач‑кнопки</h2>
        <div class="touch-wide">
          <button class="tbtn big" data-act="left">←</button>
          <button class="tbtn big" data-act="rotateCCW">⟲</button>
          <button class="tbtn big" data-act="rotateCW">⟳</button>
          <button class="tbtn big" data-act="right">→</button>
        </div>
        <div class="touch-grid">
          <button class="tbtn" data-act="hold">Hold</button>
          <button class="tbtn" data-act="drop">Drop</button>
          <button class="tbtn" data-act="down">↓</button>
        </div>
        <div class="row">
          <button class="tbtn grow" data-act="pause">Пауза</button>
          <button class="tbtn" data-act="restart">R</button>
        </div>
      </div>
      <div class="panel scores">
        <h2>Таблица рекордов (Top 10)</h2>
        <ol id="score-list"></ol>
      </div>
      <div class="footer">© Tetris — vanilla JS, один файл, без зависимостей</div>
    </div>
  </div>

  <script>
  // ========= Константы =========
  const COLS = 10, ROWS = 20;
  let SIZE = 32; // делаем динамическим для мобильной версии
  const DROP_BASE_MS = 1000, SPEED_FACTOR = 0.85;
  const COLORS = { I:'#5dd6ff', J:'#6d88ff', L:'#ffb15d', O:'#ffe45d', S:'#6dff8a', T:'#c07dff', Z:'#ff6d7a', ghost:'rgba(255,255,255,0.18)' };
  const SHAPES = {
    I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
    J:[[1,0,0],[1,1,1],[0,0,0]],
    L:[[0,0,1],[1,1,1],[0,0,0]],
    O:[[1,1],[1,1]],
    S:[[0,1,1],[1,1,0],[0,0,0]],
    T:[[0,1,0],[1,1,1],[0,0,0]],
    Z:[[1,1,0],[0,1,1],[0,0,0]],
  };
  const SCORES = {1:100,2:300,3:500,4:800};

  // ========= Утилиты =========
  const $ = s=>document.querySelector(s);
  function createMatrix(w,h,fill=0){return Array.from({length:h},()=>Array(w).fill(fill))}
  function cloneMatrix(m){return m.map(r=>r.slice())}
  function rotateMatrix(m,dir=1){const N=Math.max(m.length,m[0].length);const a=createMatrix(N,N);for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++)a[y][x]=m[y][x];const r=createMatrix(N,N);for(let y=0;y<N;y++)for(let x=0;x<N;x++)r[y][x]=dir>0?a[N-1-x][y]:a[x][N-1-y];return trimMatrix(r)}
  function trimMatrix(m){let t=m.length,l=m[0].length,b=-1,r=-1;for(let y=0;y<m.length;y++)for(let x=0;x<m[y].length;x++)if(m[y][x]){t=Math.min(t,y);l=Math.min(l,x);b=Math.max(b,y);r=Math.max(r,x)}const H=b-t+1,W=r-l+1;const res=createMatrix(W,H,0);for(let y=0;y<H;y++)for(let x=0;x<W;x++)res[y][x]=m[t+y][l+x];return res}
  function bag(){const keys=Object.keys(SHAPES);let bag=[];function refill(){bag=keys.slice();for(let i=bag.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[bag[i],bag[j]]=[bag[j],bag[i]]}}refill();return()=>{if(!bag.length)refill();return bag.pop()}}

  // ========= Звук (WebAudio) =========
  class Sound { constructor(){this.ctx=null;this.enabled=false} ensure(){ if(!this.ctx){ this.ctx=new (window.AudioContext||window.webkitAudioContext)() } if(this.ctx.state==='suspended') this.ctx.resume() } toggle(on){this.enabled=on; if(on) this.ensure()} beep(freq=440,dur=0.06,type='square',gain=0.03){if(!this.enabled)return;this.ensure();const t=this.ctx.currentTime;const o=this.ctx.createOscillator();const g=this.ctx.createGain();o.type=type;o.frequency.setValueAtTime(freq,this.ctx.currentTime);g.gain.setValueAtTime(gain,this.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.0001,t+dur);o.connect(g).connect(this.ctx.destination);o.start();o.stop(t+dur)} seq(list){let t=0;for(const [f,d,g=0.03] of list){setTimeout(()=>this.beep(f,d,'square',g),t*1000);t+=d*0.82}} }
  const SND = new Sound();

  // ========= Состояние =========
  const board=createMatrix(COLS,ROWS,0);
  let score=0,lines=0,level=1; let dropTimer=0,dropInterval=DROP_BASE_MS; let paused=false,gameOver=false;
  let canHold=true; let holdKey=null; let pick=bag(); let nextKey=pick();
  const piece={ key:nextKey, matrix:cloneMatrix(SHAPES[nextKey]), x:3, y:0 };
  nextKey=pick();

  // ========= Канвасы =========
  const boardCanvas=$('#board'), ctx=boardCanvas.getContext('2d'); ctx.imageSmoothingEnabled=false;
  const nextCanvas=$('#next'), nextCtx=nextCanvas.getContext('2d');
  const holdCanvas=$('#hold'), holdCtx=holdCanvas.getContext('2d');

  // Динамический ресайз под мобильные
  function resizeBoard(){
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio||1));
    // Доступная ширина: если левая колонка одна — почти весь экран; иначе ширина канваса контейнера
    const isNarrow = window.innerWidth <= 900;
    const maxW = isNarrow ? Math.min(window.innerWidth-32, 520) : 320; // ограничим, чтобы не распухал
    const maxH = isNarrow ? Math.min(window.innerHeight-220, 800) : 640; // оставим место под панели
    const cellByW = Math.floor(maxW / COLS);
    const cellByH = Math.floor(maxH / ROWS);
    SIZE = Math.max(14, Math.min(40, Math.min(cellByW, cellByH))); // 14–40 px
    const w = COLS*SIZE, h = ROWS*SIZE;
    // физический размер с учётом DPR
    boardCanvas.width = w * dpr; boardCanvas.height = h * dpr;
    boardCanvas.style.width = w+"px"; boardCanvas.style.height = h+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function drawCell(ctx2,gx,gy,color){const x=gx*SIZE,y=gy*SIZE;ctx2.fillStyle=color;ctx2.fillRect(x+1,y+1,SIZE-2,SIZE-2);ctx2.fillStyle='rgba(255,255,255,.06)';ctx2.fillRect(x+1,y+1,SIZE-2,Math.max(3,Math.floor(SIZE*0.12)));ctx2.fillStyle='rgba(0,0,0,.15)';ctx2.fillRect(x+1,y+SIZE-Math.max(4,Math.floor(SIZE*0.16)),SIZE-2,Math.max(3,Math.floor(SIZE*0.14)))}
  function drawBoard(){ctx.clearRect(0,0,boardCanvas.width,boardCanvas.height);for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++)if(board[y][x])drawCell(ctx,x,y,board[y][x])}
  function collides(mat,px,py){for(let y=0;y<mat.length;y++)for(let x=0;x<mat[y].length;x++){if(!mat[y][x])continue;const nx=px+x,ny=py+y; if(nx<0||nx>=COLS||ny>=ROWS)return true; if(ny>=0&&board[ny][nx])return true}return false}
  function merge(){for(let y=0;y<piece.matrix.length;y++)for(let x=0;x<piece.matrix[y].length;x++)if(piece.matrix[y][x]){const by=piece.y+y,bx=piece.x+x;if(by>=0)board[by][bx]=COLORS[piece.key]}}
  function clearLines(){let c=0;for(let y=ROWS-1;y>=0;){if(board[y].every(v=>v)){board.splice(y,1);board.unshift(Array(COLS).fill(0));c++}else y--}if(c){score+=SCORES[c]||0;lines+=c;const nl=Math.floor(lines/10)+1;if(nl!==level){level=nl;dropInterval=Math.max(80,Math.floor(DROP_BASE_MS*Math.pow(SPEED_FACTOR,level-1)))}}if(c){SND.seq([[880,.05,.04],[1174,.05,.04],[1480,.06,.05]])}}
  function getGhostY(){let gy=piece.y;while(!collides(piece.matrix,piece.x,gy+1))gy++;return gy}
  function drawPiece(showGhost=true){if(showGhost){const gy=getGhostY();for(let y=0;y<piece.matrix.length;y++)for(let x=0;x<piece.matrix[y].length;x++)if(piece.matrix[y][x])drawCell(ctx,piece.x+x,gy+y,COLORS.ghost)}for(let y=0;y<piece.matrix.length;y++)for(let x=0;x<piece.matrix[y].length;x++)if(piece.matrix[y][x])drawCell(ctx,piece.x+x,piece.y+y,COLORS[piece.key])}
  function centerMini(shape){const grid=4;const N=Math.max(shape.length,shape[0].length);const off=Math.floor((grid-N)/2);return{grid:4,off}}
  function drawMini(ctx2,key){ctx2.clearRect(0,0,120,120);if(!key)return;const sh=SHAPES[key];const {off}=centerMini(sh);const cell=22;const sx=Math.floor((120-cell*4)/2);const sy=Math.floor((120-cell*4)/2);for(let y=0;y<4;y++)for(let x=0;x<4;x++){const sx2=x-off,sy2=y-off;const f=(sh[sy2]&&sh[sy2][sx2])?1:0;if(f){const px=sx+x*cell,py=sy+y*cell;ctx2.fillStyle=COLORS[key];ctx2.fillRect(px+1,py+1,cell-2,cell-2);ctx2.fillStyle='rgba(255,255,255,.06)';ctx2.fillRect(px+1,py+1,cell-2,3);ctx2.fillStyle='rgba(0,0,0,.15)';ctx2.fillRect(px+1,py+cell-5,cell-2,4)}}}
  function updateSide(){$('#score').textContent=score;$('#lines').textContent=lines;$('#level').textContent=level;drawMini(nextCtx,nextKey);drawMini(holdCtx,holdKey)}

  function tryMove(dx,dy){if(!collides(piece.matrix,piece.x+dx,piece.y+dy)){piece.x+=dx;piece.y+=dy; return true}return false}
  const KICKS=[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:0,y:-1},{x:2,y:0},{x:-2,y:0}];
  function tryRotate(dir){const r=rotateMatrix(piece.matrix,dir);const px=piece.x,py=piece.y;for(const k of KICKS){const nx=px+k.x,ny=py+k.y;if(!collides(r,nx,ny)){piece.matrix=r;piece.x=nx;piece.y=ny;SND.beep(740,.04);return true}}return false}
  function softDrop(){if(!collides(piece.matrix,piece.x,piece.y+1)){piece.y++;score+=1;return true}else{lock();return false}}
  function hardDrop(){let d=0;while(!collides(piece.matrix,piece.x,piece.y+1)){piece.y++;d++}score+=d*2;SND.seq([[196,.05,.04],[392,.05,.04],[784,.05,.04]]);lock()}
  function lock(){merge();clearLines();spawnNext()}
  function spawnNext(){canHold=true;piece.key=nextKey;piece.matrix=cloneMatrix(SHAPES[piece.key]);piece.x=Math.floor((COLS-piece.matrix[0].length)/2);piece.y=-1;nextKey=pick();if(collides(piece.matrix,piece.x,piece.y+1)){gameOver=true;paused=false;showOverlay()}updateSide()}
  function hold(){if(!canHold) return; const cur=piece.key; if(holdKey===null){holdKey=cur; spawnNext()} else { piece.key=holdKey; piece.matrix=cloneMatrix(SHAPES[piece.key]); piece.x=Math.floor((COLS-piece.matrix[0].length)/2); piece.y=-1; holdKey=cur; if(collides(piece.matrix,piece.x,piece.y+1)){gameOver=true; showOverlay()} } canHold=false; updateSide(); SND.beep(520,.05)}

  // ========= Игровой цикл =========
  let lastTime=0; function loop(t=0){const dt=t-lastTime;lastTime=t;if(!paused&&!gameOver){dropTimer+=dt;if(dropTimer>=dropInterval){dropTimer=0;softDrop()}}drawBoard(); if(!gameOver) drawPiece(true); requestAnimationFrame(loop)}

  // ========= Оверлей/рекорды =========
  const overlay=$('#overlay'); const ovScore=$('#ov-score'); const ovLines=$('#ov-lines'); const ovLevel=$('#ov-level');
  function showOverlay(){ovScore.textContent=String(score);ovLines.textContent=String(lines);ovLevel.textContent=String(level);overlay.classList.add('show')}
  function hideOverlay(){overlay.classList.remove('show')}

  const LB_KEY='tetrisLeaderboardV1';
  function loadLB(){try{const raw=localStorage.getItem(LB_KEY);return raw?JSON.parse(raw):[]}catch(e){return[]}}
  function saveLB(list){try{localStorage.setItem(LB_KEY,JSON.stringify(list))}catch(e){}}
  function addRecord(name,scoreV,linesV,levelV){const list=loadLB();const rec={name:String(name||'Игрок').slice(0,24),score:scoreV,lines:linesV,level:levelV,date:new Date().toISOString()};list.push(rec);list.sort((a,b)=>b.score-a.score);saveLB(list.slice(0,10));renderLB()}
  function renderLB(){const list=loadLB();const ol=$('#score-list');ol.innerHTML='';list.forEach((r)=>{const li=document.createElement('li');const d=new Date(r.date);const ds=d.toLocaleDateString();li.textContent=`${r.name} — ${r.score} очк., ${r.lines} линий, ур. ${r.level} · ${ds}`;ol.appendChild(li)})}

  // ========= Ввод =========
  const Key={Left:'ArrowLeft',Right:'ArrowRight',Down:'ArrowDown',Up:'ArrowUp',Space:' ',Z:'z',X:'x',C:'c',P:'p',R:'r',M:'m'};
  document.addEventListener('keydown',(e)=>{
    const k=e.key; const low=k.toLowerCase();
    if(low===Key.P){paused=!paused;return}
    if(low===Key.R){restart();return}
    if(low==='m'){toggleSound();return}
    if(gameOver||paused)return;
    switch(k){
      case Key.Left: tryMove(-1,0)&&SND.beep(330,.03); break;
      case Key.Right: tryMove(1,0)&&SND.beep(330,.03); break;
      case Key.Down: softDrop(); break;
      case Key.Up: case 'x': case 'X': tryRotate(1); break;
      case 'z': case 'Z': tryRotate(-1); break;
      case 'c': case 'C': hold(); break;
      case Key.Space: e.preventDefault(); hardDrop(); break;
    }
  },{passive:false});

  // ========= Тач‑кнопки =========
  const touchMap={left:()=>tryMove(-1,0)&&SND.beep(330,.03), right:()=>tryMove(1,0)&&SND.beep(330,.03), down:()=>softDrop(), rotateCW:()=>tryRotate(1), rotateCCW:()=>tryRotate(-1), drop:()=>hardDrop(), hold:()=>hold(), pause:()=>{paused=!paused}, restart:()=>restart()};
  const holdable=new Set(['left','right','down']);
  let holdTimer=null;
  function startHold(act){stopHold(); act(); holdTimer=setInterval(()=>{if(!paused&&!gameOver) act();}, 90)}
  function stopHold(){if(holdTimer){clearInterval(holdTimer); holdTimer=null}}
  document.querySelectorAll('[data-act]').forEach(btn=>{
    const actName=btn.getAttribute('data-act');
    const act=()=>{ if(gameOver||paused){ if(actName==='restart') touchMap[actName](); else if(actName==='pause') touchMap[actName](); return } touchMap[actName]&&touchMap[actName]() };
    btn.addEventListener('touchstart',(e)=>{e.preventDefault(); SND.ensure(); if(holdable.has(actName)) startHold(act); else act()},{passive:false});
    btn.addEventListener('touchend',()=>stopHold());
    btn.addEventListener('touchcancel',()=>stopHold());
    btn.addEventListener('mousedown',(e)=>{e.preventDefault(); if(holdable.has(actName)) startHold(act); else act()});
    btn.addEventListener('mouseup',()=>stopHold());
    btn.addEventListener('mouseleave',()=>stopHold());
  });

  // ========= Кнопки UI =========
  $('#btn-pause').addEventListener('click',()=>paused=!paused);
  $('#btn-restart').addEventListener('click',()=>restart());
  $('#btn-restart2').addEventListener('click',()=>{hideOverlay(); restart()});
  $('#btn-save').addEventListener('click',()=>{const name=$('#playerName').value||'Игрок'; addRecord(name,score,lines,level); hideOverlay(); restart()});
  $('#btn-clear-scores').addEventListener('click',()=>{localStorage.removeItem(LB_KEY); renderLB()});
  $('#btn-sound').addEventListener('click',()=>toggleSound());

  function toggleSound(){SND.toggle(!SND.enabled); $('#btn-sound').textContent='Звук: '+(SND.enabled?'вкл':'выкл'); if(SND.enabled) SND.seq([[660,.05,.03],[880,.05,.03]])}

  // ========= Рестарт =========
  function restart(){for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++)board[y][x]=0; score=0;lines=0;level=1;dropInterval=DROP_BASE_MS;dropTimer=0; paused=false;gameOver=false; holdKey=null; canHold=true; pick=bag(); nextKey=pick(); piece.key=nextKey; piece.matrix=cloneMatrix(SHAPES[piece.key]); piece.x=3; piece.y=0; nextKey=pick(); updateSide();}

  // ========= Инициализация =========
  function init(){resizeBoard(); updateSide(); renderLB(); requestAnimationFrame(loop)}
  window.addEventListener('resize',()=>{const oldSize=SIZE; resizeBoard(); if(SIZE!==oldSize){ /* просто перерисуем; логика остаётся */ } });
  init();

  </script>
</body>
</html>
